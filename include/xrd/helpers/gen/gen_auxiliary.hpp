#pragma once
// Xrd-eXternalrEsolve - SDK 生成：辅助文件
// 生成 PropertyFixup.hpp / NameCollisions.inl / Assertions.inl（头部）
// UnrealContainers.hpp / UtfN.hpp 直接嵌入静态内容

#include "../../core/context.hpp"
#include "../dump_prefix.hpp"
#include <fstream>
#include <string>
#include <filesystem>
#include <map>
#include <vector>

namespace xrd
{
namespace gen
{

// 生成 PropertyFixup.hpp — 对齐 Rei-Dumper 格式
inline void GeneratePropertyFixup(const std::wstring& cppSdkDir)
{
    std::wstring path = cppSdkDir + L"/PropertyFixup.hpp";
    std::ofstream f(path);
    if (!f.is_open()) return;

    f << R"(#pragma once

/*
* SDK generated by Xrd-eXternalrEsolve
* Based on Dumper-7
*
* https://github.com/Encryqed/Dumper-7
*/

// PROPERTY-FIXUP


namespace SDK
{

class alignas(0x01) FMulticastSparseDelegateProperty_
{
	unsigned __int8 Pad[0x1];
};

}

)";
    f.close();
}

// 生成 NameCollisions.inl — 对齐 Rei-Dumper 格式
// 对标 Rei-Dumper：为包名冲突的类生成命名空间前向声明
inline void GenerateNameCollisions(
    const std::wstring& cppSdkDir,
    const std::map<std::string, std::string>& collisionNsMap,
    const std::vector<xrd::detail::StructEntry>& entries)
{
    std::wstring path = cppSdkDir + L"/NameCollisions.inl";
    std::ofstream f(path);
    if (!f.is_open()) return;

    f << R"(#pragma once

/*
* SDK generated by Xrd-eXternalrEsolve
* Based on Dumper-7
*
* https://github.com/Encryqed/Dumper-7
*/

// FORWARD DECLARATIONS

)";

    // 收集冲突包中的类，按命名空间分组
    // 对标 Rei-Dumper：namespace PkgName { class UClassName; }
    std::map<std::string, std::vector<std::string>> nsFwdDecls;
    for (auto& e : entries)
    {
        if (!e.collisionNs.empty() && e.isClass)
        {
            std::string prefixed = xrd::detail::AddStructPrefix(
                e.name, e.isClass,
                e.isActorChild, e.isInterfaceChild);
            nsFwdDecls[e.collisionNs].push_back(prefixed);
        }
    }

    if (!nsFwdDecls.empty())
    {
        f << "\n";
        for (auto& [ns, classes] : nsFwdDecls)
        {
            for (auto& cls : classes)
            {
                f << "namespace " << ns
                  << " { class " << cls << "; }\n";
            }
        }
    }

    f << "\n";
    f.close();
}

// Basic.hpp 中预定义类型的断言宏（必须在 GenerateAssertionsHeader 之前定义）
inline void WriteBasicAssertions(std::ofstream& f)
{
    auto& ctx = Ctx();
    i32 itemSize = ctx.off.FUObjectItemSize > 0 ? ctx.off.FUObjectItemSize : 0x18;

    f << R"(#define DUMPER7_ASSERTS_FUObjectItem \
static_assert(alignof(FUObjectItem) == 0x000008, "Wrong alignment on FUObjectItem"); \
static_assert(sizeof(FUObjectItem) == 0x)" << std::format("{:06X}", itemSize) << R"(, "Wrong size on FUObjectItem"); \
static_assert(offsetof(FUObjectItem, Object) == 0x000000, "Member 'FUObjectItem::Object' has a wrong offset!"); \

#define DUMPER7_ASSERTS_TUObjectArray \
static_assert(alignof(TUObjectArray) == 0x000008, "Wrong alignment on TUObjectArray"); \
static_assert(sizeof(TUObjectArray) == 0x000020, "Wrong size on TUObjectArray"); \
static_assert(offsetof(TUObjectArray, Objects) == 0x000000, "Member 'TUObjectArray::Objects' has a wrong offset!"); \
static_assert(offsetof(TUObjectArray, MaxElements) == 0x000010, "Member 'TUObjectArray::MaxElements' has a wrong offset!"); \
static_assert(offsetof(TUObjectArray, NumElements) == 0x000014, "Member 'TUObjectArray::NumElements' has a wrong offset!"); \
static_assert(offsetof(TUObjectArray, MaxChunks) == 0x000018, "Member 'TUObjectArray::MaxChunks' has a wrong offset!"); \
static_assert(offsetof(TUObjectArray, NumChunks) == 0x00001C, "Member 'TUObjectArray::NumChunks' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FName \
static_assert(alignof(FName) == 0x000004, "Wrong alignment on FName"); \
static_assert(sizeof(FName) == 0x000008, "Wrong size on FName"); \
static_assert(offsetof(FName, ComparisonIndex) == 0x000000, "Member 'FName::ComparisonIndex' has a wrong offset!"); \
static_assert(offsetof(FName, Number) == 0x000004, "Member 'FName::Number' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FTextData \
static_assert(alignof(FTextData) == 0x000008, "Wrong alignment on FTextData"); \
static_assert(sizeof(FTextData) == 0x000038, "Wrong size on FTextData"); \
static_assert(offsetof(FTextData, TextSource) == 0x000028, "Member 'FTextData::TextSource' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FText \
static_assert(alignof(FText) == 0x000008, "Wrong alignment on FText"); \
static_assert(sizeof(FText) == 0x000018, "Wrong size on FText"); \
static_assert(offsetof(FText, TextData) == 0x000000, "Member 'FText::TextData' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FWeakObjectPtr \
static_assert(alignof(FWeakObjectPtr) == 0x000004, "Wrong alignment on FWeakObjectPtr"); \
static_assert(sizeof(FWeakObjectPtr) == 0x000008, "Wrong size on FWeakObjectPtr"); \
static_assert(offsetof(FWeakObjectPtr, ObjectIndex) == 0x000000, "Member 'FWeakObjectPtr::ObjectIndex' has a wrong offset!"); \
static_assert(offsetof(FWeakObjectPtr, ObjectSerialNumber) == 0x000004, "Member 'FWeakObjectPtr::ObjectSerialNumber' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FUniqueObjectGuid \
static_assert(alignof(FUniqueObjectGuid) == 0x000004, "Wrong alignment on FUniqueObjectGuid"); \
static_assert(sizeof(FUniqueObjectGuid) == 0x000010, "Wrong size on FUniqueObjectGuid"); \
static_assert(offsetof(FUniqueObjectGuid, A) == 0x000000, "Member 'FUniqueObjectGuid::A' has a wrong offset!"); \
static_assert(offsetof(FUniqueObjectGuid, B) == 0x000004, "Member 'FUniqueObjectGuid::B' has a wrong offset!"); \
static_assert(offsetof(FUniqueObjectGuid, C) == 0x000008, "Member 'FUniqueObjectGuid::C' has a wrong offset!"); \
static_assert(offsetof(FUniqueObjectGuid, D) == 0x00000C, "Member 'FUniqueObjectGuid::D' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FSoftObjectPath \
static_assert(alignof(FSoftObjectPath) == 0x000008, "Wrong alignment on FSoftObjectPath"); \
static_assert(sizeof(FSoftObjectPath) == 0x000018, "Wrong size on FSoftObjectPath"); \
static_assert(offsetof(FSoftObjectPath, AssetPathName) == 0x000000, "Member 'FSoftObjectPath::AssetPathName' has a wrong offset!"); \
static_assert(offsetof(FSoftObjectPath, SubPathString) == 0x000008, "Member 'FSoftObjectPath::SubPathString' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FScriptInterface \
static_assert(alignof(FScriptInterface) == 0x000008, "Wrong alignment on FScriptInterface"); \
static_assert(sizeof(FScriptInterface) == 0x000010, "Wrong size on FScriptInterface"); \
static_assert(offsetof(FScriptInterface, ObjectPointer) == 0x000000, "Member 'FScriptInterface::ObjectPointer' has a wrong offset!"); \
static_assert(offsetof(FScriptInterface, InterfacePointer) == 0x000008, "Member 'FScriptInterface::InterfacePointer' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FFieldPath \
static_assert(alignof(FFieldPath) == 0x000008, "Wrong alignment on FFieldPath"); \
static_assert(sizeof(FFieldPath) == 0x000020, "Wrong size on FFieldPath"); \
static_assert(offsetof(FFieldPath, ResolvedField) == 0x000000, "Member 'FFieldPath::ResolvedField' has a wrong offset!"); \
static_assert(offsetof(FFieldPath, ResolvedOwner) == 0x000008, "Member 'FFieldPath::ResolvedOwner' has a wrong offset!"); \
static_assert(offsetof(FFieldPath, Path) == 0x000010, "Member 'FFieldPath::Path' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FScriptDelegate \
static_assert(alignof(FScriptDelegate) == 0x000004, "Wrong alignment on FScriptDelegate"); \
static_assert(sizeof(FScriptDelegate) == 0x000010, "Wrong size on FScriptDelegate"); \
static_assert(offsetof(FScriptDelegate, Object) == 0x000000, "Member 'FScriptDelegate::Object' has a wrong offset!"); \
static_assert(offsetof(FScriptDelegate, FunctionName) == 0x000008, "Member 'FScriptDelegate::FunctionName' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FFieldClass \
static_assert(alignof(FFieldClass) == 0x000008, "Wrong alignment on FFieldClass"); \
static_assert(sizeof(FFieldClass) == 0x000028, "Wrong size on FFieldClass"); \
static_assert(offsetof(FFieldClass, Name) == 0x000000, "Member 'FFieldClass::Name' has a wrong offset!"); \
static_assert(offsetof(FFieldClass, Id) == 0x000008, "Member 'FFieldClass::Id' has a wrong offset!"); \
static_assert(offsetof(FFieldClass, CastFlags) == 0x000010, "Member 'FFieldClass::CastFlags' has a wrong offset!"); \
static_assert(offsetof(FFieldClass, ClassFlags) == 0x000018, "Member 'FFieldClass::ClassFlags' has a wrong offset!"); \
static_assert(offsetof(FFieldClass, SuperClass) == 0x000020, "Member 'FFieldClass::SuperClass' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FFieldVariant \
static_assert(alignof(FFieldVariant) == 0x000008, "Wrong alignment on FFieldVariant"); \
static_assert(sizeof(FFieldVariant) == 0x000010, "Wrong size on FFieldVariant"); \
static_assert(offsetof(FFieldVariant, Container) == 0x000000, "Member 'FFieldVariant::Container' has a wrong offset!"); \
static_assert(offsetof(FFieldVariant, bIsUObject) == 0x000008, "Member 'FFieldVariant::bIsUObject' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FField \
static_assert(alignof(FField) == 0x000008, "Wrong alignment on FField"); \
static_assert(sizeof(FField) == 0x000038, "Wrong size on FField"); \
static_assert(offsetof(FField, VTable) == 0x000000, "Member 'FField::VTable' has a wrong offset!"); \
static_assert(offsetof(FField, ClassPrivate) == 0x000008, "Member 'FField::ClassPrivate' has a wrong offset!"); \
static_assert(offsetof(FField, Owner) == 0x000010, "Member 'FField::Owner' has a wrong offset!"); \
static_assert(offsetof(FField, Next) == 0x000020, "Member 'FField::Next' has a wrong offset!"); \
static_assert(offsetof(FField, Name) == 0x000028, "Member 'FField::Name' has a wrong offset!"); \
static_assert(offsetof(FField, ObjFlags) == 0x000030, "Member 'FField::ObjFlags' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FProperty \
static_assert(alignof(FProperty) == 0x000008, "Wrong alignment on FProperty"); \
static_assert(sizeof(FProperty) == 0x000078, "Wrong size on FProperty"); \
static_assert(offsetof(FProperty, ArrayDim) == 0x000038, "Member 'FProperty::ArrayDim' has a wrong offset!"); \
static_assert(offsetof(FProperty, ElementSize) == 0x00003C, "Member 'FProperty::ElementSize' has a wrong offset!"); \
static_assert(offsetof(FProperty, PropertyFlags) == 0x000040, "Member 'FProperty::PropertyFlags' has a wrong offset!"); \
static_assert(offsetof(FProperty, Offset) == 0x00004C, "Member 'FProperty::Offset' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FByteProperty \
static_assert(alignof(FByteProperty) == 0x000008, "Wrong alignment on FByteProperty"); \
static_assert(sizeof(FByteProperty) == 0x000080, "Wrong size on FByteProperty"); \
static_assert(offsetof(FByteProperty, Enum) == 0x000078, "Member 'FByteProperty::Enum' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FBoolProperty \
static_assert(alignof(FBoolProperty) == 0x000008, "Wrong alignment on FBoolProperty"); \
static_assert(sizeof(FBoolProperty) == 0x000080, "Wrong size on FBoolProperty"); \
static_assert(offsetof(FBoolProperty, FieldSize) == 0x000078, "Member 'FBoolProperty::FieldSize' has a wrong offset!"); \
static_assert(offsetof(FBoolProperty, ByteOffset) == 0x000079, "Member 'FBoolProperty::ByteOffset' has a wrong offset!"); \
static_assert(offsetof(FBoolProperty, ByteMask) == 0x00007A, "Member 'FBoolProperty::ByteMask' has a wrong offset!"); \
static_assert(offsetof(FBoolProperty, FieldMask) == 0x00007B, "Member 'FBoolProperty::FieldMask' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FObjectPropertyBase \
static_assert(alignof(FObjectPropertyBase) == 0x000008, "Wrong alignment on FObjectPropertyBase"); \
static_assert(sizeof(FObjectPropertyBase) == 0x000080, "Wrong size on FObjectPropertyBase"); \
static_assert(offsetof(FObjectPropertyBase, PropertyClass) == 0x000078, "Member 'FObjectPropertyBase::PropertyClass' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FClassProperty \
static_assert(alignof(FClassProperty) == 0x000008, "Wrong alignment on FClassProperty"); \
static_assert(sizeof(FClassProperty) == 0x000088, "Wrong size on FClassProperty"); \
static_assert(offsetof(FClassProperty, MetaClass) == 0x000080, "Member 'FClassProperty::MetaClass' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FStructProperty \
static_assert(alignof(FStructProperty) == 0x000008, "Wrong alignment on FStructProperty"); \
static_assert(sizeof(FStructProperty) == 0x000080, "Wrong size on FStructProperty"); \
static_assert(offsetof(FStructProperty, Struct) == 0x000078, "Member 'FStructProperty::Struct' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FArrayProperty \
static_assert(alignof(FArrayProperty) == 0x000008, "Wrong alignment on FArrayProperty"); \
static_assert(sizeof(FArrayProperty) == 0x000080, "Wrong size on FArrayProperty"); \
static_assert(offsetof(FArrayProperty, InnerProperty) == 0x000078, "Member 'FArrayProperty::InnerProperty' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FDelegateProperty \
static_assert(alignof(FDelegateProperty) == 0x000008, "Wrong alignment on FDelegateProperty"); \
static_assert(sizeof(FDelegateProperty) == 0x000080, "Wrong size on FDelegateProperty"); \
static_assert(offsetof(FDelegateProperty, SignatureFunction) == 0x000078, "Member 'FDelegateProperty::SignatureFunction' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FMapProperty \
static_assert(alignof(FMapProperty) == 0x000008, "Wrong alignment on FMapProperty"); \
static_assert(sizeof(FMapProperty) == 0x000088, "Wrong size on FMapProperty"); \
static_assert(offsetof(FMapProperty, KeyProperty) == 0x000078, "Member 'FMapProperty::KeyProperty' has a wrong offset!"); \
static_assert(offsetof(FMapProperty, ValueProperty) == 0x000080, "Member 'FMapProperty::ValueProperty' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FSetProperty \
static_assert(alignof(FSetProperty) == 0x000008, "Wrong alignment on FSetProperty"); \
static_assert(sizeof(FSetProperty) == 0x000080, "Wrong size on FSetProperty"); \
static_assert(offsetof(FSetProperty, ElementProperty) == 0x000078, "Member 'FSetProperty::ElementProperty' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FEnumProperty \
static_assert(alignof(FEnumProperty) == 0x000008, "Wrong alignment on FEnumProperty"); \
static_assert(sizeof(FEnumProperty) == 0x000088, "Wrong size on FEnumProperty"); \
static_assert(offsetof(FEnumProperty, UnderlayingProperty) == 0x000078, "Member 'FEnumProperty::UnderlayingProperty' has a wrong offset!"); \
static_assert(offsetof(FEnumProperty, Enum) == 0x000080, "Member 'FEnumProperty::Enum' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FFieldPathProperty \
static_assert(alignof(FFieldPathProperty) == 0x000008, "Wrong alignment on FFieldPathProperty"); \
static_assert(sizeof(FFieldPathProperty) == 0x000080, "Wrong size on FFieldPathProperty"); \
static_assert(offsetof(FFieldPathProperty, FieldClass) == 0x000078, "Member 'FFieldPathProperty::FieldClass' has a wrong offset!"); \

#define DUMPER7_ASSERTS_FOptionalProperty \
static_assert(alignof(FOptionalProperty) == 0x000008, "Wrong alignment on FOptionalProperty"); \
static_assert(sizeof(FOptionalProperty) == 0x000080, "Wrong size on FOptionalProperty"); \
static_assert(offsetof(FOptionalProperty, ValueProperty) == 0x000078, "Member 'FOptionalProperty::ValueProperty' has a wrong offset!"); \

)";

    // 闭合 namespace SDK
    f << "}\n";
}

// 生成 Assertions.inl 的头部（基础类型断言宏）
// 每个包的断言会在包文件生成时追加到此文件
inline void GenerateAssertionsHeader(const std::wstring& cppSdkDir)
{
    std::wstring path = cppSdkDir + L"/Assertions.inl";
    std::ofstream f(path);
    if (!f.is_open()) return;

    f << R"(#pragma once

/*
* SDK generated by Xrd-eXternalrEsolve
* Based on Dumper-7
*
* https://github.com/Encryqed/Dumper-7
*/

// Debug assertions to verify member-offsets and struct-sizes
// 如需禁用断言，在 include SDK.hpp 之前 #define DUMPER7_DISABLE_ASSERTS

#ifndef DUMPER7_DISABLE_ASSERTS

namespace SDK
{
)";

    // 写入 Basic.hpp 中预定义类型的断言宏
    WriteBasicAssertions(f);

    f.close();
}

} // namespace gen
} // namespace xrd
